name: submit-dependency-graph
runs:
  using: "composite"
  steps:
    - name: Download the artifact via script
      uses: actions/github-script@v6
      with:
        script: |
            var artifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: ${{github.event.workflow_run.id }},
            });
            console.log(artifacts);
            var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "dependency-graph"
            })[0];
            var download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });

            var fs = require('fs');
            fs.writeFileSync('${{github.workspace}}/dependency-graph.zip', Buffer.from(download.data));
    - run: ls -la
      shell: bash
    - run: unzip dependency-graph.zip
      shell: bash
    - name: Report dependency graph
      run: |
        cat github-dependency-manifest.json 
    - name: Upload dependency graph via script
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs')
          const path = require('path')
          
          const jsonFile = path.resolve('github-dependency-manifest.json')
          core.warning(`READING JSON from file: ${jsonFile}`)
          
          const jsonContent = fs.readFileSync(jsonFile, 'utf8')
          core.warning(`READ JSON CONTENT: ${jsonContent}`)
          
          const jsonObject = JSON.parse(jsonContent)
          jsonObject.owner = context.repo.owner
          jsonObject.repo = context.repo.repo
          const response = await github.request('POST /repos/{owner}/{repo}/dependency-graph/snapshots', jsonObject)          
          
          core.warning(`SUBMITTED: ${JSON.stringify(response)}`)
