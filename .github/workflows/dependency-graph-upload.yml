name: dependency-graph-upload
on:
  workflow_run:
    workflows: ["dependency-graph"]
    types:
      - completed

permissions: write-all

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
    - name: Use the GH API
      env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "workflow run_id = ${{github.event.workflow_run.id }}"
        gh api /repos/bigdaz/test-dependency-graph/actions/runs/${{github.event.workflow_run.id }}/artifacts
    - name: Use script
      uses: actions/github-script@v6
      with:
        script: |
            var artifacts = await github.actions.listWorkflowRunArtifacts({
               owner: "bigdaz",
               repo: "test-dependency-graph",
               run_id: ${{github.event.workflow_run.id }},
            });
            console.log(artifacts);
#             var matchArtifact = artifacts.data.artifacts.filter((artifact) => {
#               return artifact.name == "dependency-graph"
#             })[0];
#             var download = await github.actions.downloadArtifact({
#                owner: context.repo.owner,
#                repo: context.repo.repo,
#                artifact_id: matchArtifact.id,
#                archive_format: 'zip',
#             });

#             var fs = require('fs');
#             fs.writeFileSync('${{github.workspace}}/dependency-graph.zip', Buffer.from(download.data));
#     - run: ls -la
#     - run: unzip dependency-graph.zip
#     - run: ls -la
#     - name: Report dependency graph
#       run: |
#         ls -la github-dependency-report
#         cat github-dependency-report/github-dependency-manifest.json 
#     - name: Upload dependency graph
#       run: |
#         curl -L -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ github.token }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/bigdaz/test-dependency-graph/dependency-graph/snapshots -d @github-dependency-report/github-dependency-manifest.json
